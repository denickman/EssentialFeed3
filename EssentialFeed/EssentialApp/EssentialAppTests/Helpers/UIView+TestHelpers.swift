//
//  UIView+TestHelpers.swift
//  EssentialAppTests
//
//  Created by Denis Yaremenko on 17.02.2025.
//

import UIKit

/*
 layoutIfNeeded() заставляет UIView пересчитать и применить изменения макета (позиции, размеры субвью) прямо сейчас, не дожидаясь следующего естественного обновления в цикле RunLoop. То есть он выполняет этап "layout" немедленно.
 Однако это не гарантирует, что все последующие шаги (например, отрисовка на экране или завершение связанных операций) тоже произойдут сразу. После пересчета макета изменения могут остаться в "очереди" на финальное выполнение в текущем цикле RunLoop.
 
 Почему нужен RunLoop.current.run(until: Date())?
 layoutIfNeeded() только пересчитывает макет, но не заставляет RunLoop немедленно завершить весь цикл обработки (например, отрисовку или другие накопленные задачи).
 RunLoop.current.run(until: Date()) говорит: "Выполни все задачи, которые сейчас в очереди, до текущего момента времени". Это завершает весь процесс обновления UI, включая отрисовку, а не только пересчет макета.
 
 Если без RunLoop.run, то после layoutIfNeeded() результат может "зависнуть" до следующего кадра. RunLoop.run убирает эту задержку.
 
Отложенное обновление UI:
В UIKit изменения в интерфейсе (например, размеры, положение элементов) не применяются сразу. Они накапливаются и выполняются в следующем цикле RunLoop — это механизм, который управляет событиями и обновлениями в приложении. Обычно это происходит перед следующим обновлением экрана (например, 60 раз в секунду на 60 Гц дисплее).
Из-за этого, если вы меняете UI асинхронно (например, после загрузки данных с сервера), результат может не отобразиться сразу.

Если вы, например, загружаете данные с сервера и обновляете UI в фоновом потоке, без такого подхода изменения могут "зависнуть" до следующего кадра. enforceLayoutCycle() форсирует немедленное обновление, что важно для плавности или точности (например, в анимациях или при динамическом изменении размеров).

Код решает проблему отложенного обновления UI в UIKit, предоставляя способ принудительно применить изменения макета и завершить их обработку в текущем цикле, особенно в асинхронных или сложных сценариях.
*/

extension UIView {
    func enforceLayoutCycle() {
        layoutIfNeeded()
        RunLoop.current.run(until: Date())
    }
}
